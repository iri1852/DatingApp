<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onze Date Planner 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .view { display: none; }
        .view.active { display: block; }
    </style>
</head>
<body class="bg-indigo-50 min-h-screen font-sans">

    <nav class="bg-white shadow-sm p-4 sticky top-0 z-10">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 onclick="showView('home')" class="text-2xl font-bold text-indigo-600 cursor-pointer">üë©‚Äç‚ù§Ô∏è‚Äçüë® DateApp</h1>
            <button onclick="showView('add')" class="bg-indigo-600 text-white px-4 py-2 rounded-full font-medium hover:bg-indigo-700">+ Nieuw</button>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto p-4">

        <section id="homeView" class="view active">
            <h2 class="text-xl font-semibold mb-6 text-gray-800">Onze Bucketlist</h2>
            <div id="datesGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                </div>
        </section>

        <section id="formView" class="view">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h2 id="formTitle" class="text-2xl font-bold mb-6 text-gray-800">Nieuw idee toevoegen</h2>
                <input type="hidden" id="editId">
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Wat gaan we doen? *</label>
                        <input type="text" id="title" class="w-full p-3 border rounded-xl mt-1">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Door wie?</label>
                            <input type="text" id="createdBy" placeholder="Jouw naam" class="w-full p-3 border rounded-xl mt-1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Wanneer? (optioneel)</label>
                            <input type="date" id="dateSuggested" class="w-full p-3 border rounded-xl mt-1">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Details / Omschrijving</label>
                        <textarea id="description" rows="3" class="w-full p-3 border rounded-xl mt-1"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Foto uploaden (Sfeer of Herinnering)</label>
                        <input type="file" id="imageFile" accept="image/*" class="w-full mt-1">
                    </div> 
                    <div class="flex gap-3 pt-4">
                        <button onclick="saveDate()" id="saveBtn" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg">Opslaan ‚ú®</button>
                        <button onclick="showView('home')" class="px-6 py-3 border rounded-xl text-gray-600">Annuleren</button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        const SUPABASE_URL = 'https://jwlysukkajzgxbjymzxt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3bHlzdWtrYWp6Z3hianltenh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNTE5NzIsImV4cCI6MjA4MzcyNzk3Mn0.LvNzHeX5nPEE4NCKrERllnVs8jUxre48l8pXmPBTGnM';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- Router ---
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            if(viewName === 'home') {
                document.getElementById('homeView').classList.add('active');
                fetchDates();
            } else if(viewName === 'add') {
                document.getElementById('formView').classList.add('active');
                resetForm();
                document.getElementById('formTitle').innerText = "Nieuw idee toevoegen";
            } else if(viewName === 'edit') {
                document.getElementById('formView').classList.add('active');
                document.getElementById('formTitle').innerText = "Date Aanpassen";
            }
        }

        function resetForm() {
            document.getElementById('editId').value = '';
            document.getElementById('title').value = '';
            document.getElementById('description').value = '';
            document.getElementById('createdBy').value = '';
            document.getElementById('dateSuggested').value = '';
            document.getElementById('imageFile').value = '';
        }

        // --- Data ophalen ---
        async function fetchDates() {
            const { data, error } = await supabaseClient.from('DatingDB').select('*').order('id', { ascending: false });
            const grid = document.getElementById('datesGrid');
            grid.innerHTML = '';

            data.forEach(date => {
                const img = date.image_url ? date.image_url : 'https://via.placeholder.com/400x200?text=Geen+foto';
                grid.innerHTML += `
                    <div class="bg-white rounded-2xl overflow-hidden shadow-md hover:shadow-xl transition cursor-pointer group">
                        <img src="${img}" class="h-48 w-full object-cover">
                        <div class="p-5">
                            <div class="flex justify-between items-start">
                                <h3 class="text-lg font-bold text-gray-900">${date.title}</h3>
                                <span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full">${date.created_by || 'Onbekend'}</span>
                            </div>
                            <p class="text-gray-500 text-sm mt-2 line-clamp-2">${date.description || ''}</p>
                            <div class="mt-4 flex justify-between items-center">
                                <span class="text-xs text-gray-400">üìÖ ${date.date_suggested || 'Nog geen datum'}</span>
                                <button onclick="editDate(${JSON.stringify(date).replace(/"/g, '&quot;')})" class="text-indigo-600 font-medium text-sm">Aanpassen</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // --- Uploaden & Opslaan ---
        async function saveDate() {
            const btn = document.getElementById('saveBtn');
            const id = document.getElementById('editId').value;
            const file = document.getElementById('imageFile').files[0];
            
            btn.disabled = true;
            btn.innerText = "Bezig met verwerken...";

            let imageUrl = null;

            // Foto uploaden naar Supabase Storage
            if (file) {
                const fileName = `${Date.now()}_${file.name}`;
                const { data: uploadData, error: uploadError } = await supabaseClient.storage
                    .from('date-photos')
                    .upload(fileName, file);
                
                if (uploadData) {
                    const { data: urlData } = supabaseClient.storage
                        .from('date-photos')
                        .getPublicUrl(fileName);
                    imageUrl = urlData.publicUrl;
                }
            }

            const payload = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                created_by: document.getElementById('createdBy').value,
                date_suggested: document.getElementById('dateSuggested').value || null
            };

            if (imageUrl) payload.image_url = imageUrl;

            let result;
            if (id) {
                result = await supabaseClient.from('DatingDB').update(payload).eq('id', id);
            } else {
                result = await supabaseClient.from('DatingDB').insert([payload]);
            }

            if (result.error) alert("Fout: " + result.error.message);
            else showView('home');

            btn.disabled = false;
            btn.innerText = "Opslaan ‚ú®";
        }

        function editDate(date) {
            showView('edit');
            document.getElementById('editId').value = date.id;
            document.getElementById('title').value = date.title;
            document.getElementById('description').value = date.description;
            document.getElementById('createdBy').value = date.created_by;
            document.getElementById('dateSuggested').value = date.date_suggested;
        }

        fetchDates();
    </script>
</body>
</html>